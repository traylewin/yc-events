name: Claude Test Coverage Check

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths:
      - 'app/**/*.ts'
      - 'app/**/*.tsx'
      - 'lib/**/*.ts'
      - 'lib/**/*.tsx'

jobs:
  test-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Run tests
        run: bun run test:all 2>&1 | tee test-output.txt
        continue-on-error: true

      - name: Claude Test Analysis
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are a senior engineer reviewing test coverage for PR ${{ github.repository }}/pull/${{ github.event.pull_request.number }}.

            DO NOT aim for 100% coverage. Focus only on critical-path code that must never break:
            1. Auth & authorization (login, guards, token handling)
            2. Money & billing (calculations, transactions)
            3. Data mutations (create, update, delete on core entities)
            4. API contracts (validation, response shape, error codes)
            5. Security boundaries (sanitization, permission checks)
            6. Bug fixes (every fix should have a regression test)

            SKIP test suggestions for:
            - Pure UI layout/styling with no logic
            - Config files, constants, auto-generated code
            - Simple pass-through wrappers

            Review the diff and test output. For each gap:
            - Name the critical path that's untested
            - Explain why a test matters there
            - Suggest a concrete test case name

            If all critical paths are tested, approve with a brief note.
